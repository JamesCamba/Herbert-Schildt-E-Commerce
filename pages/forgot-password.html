<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Herbert Schildt</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/forgot-password.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <img src="../img/logo-white.svg" alt="Herbert Schildt Logo" class="logo-image">
            </div>
        </div>
        <nav class="nav">
            <a href="../index.html" class="nav-link">Home</a>
            <a href="#" class="nav-link">About</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="verification-container">
            <div class="verification-card">
                <h2 class="verification-title">Choose how you'd like to receive your verification code</h2>

                <div class="verification-options">
                    <div class="verification-option" id="emailOption">
                        <div class="option-content">
                            <div class="option-label">Email</div>
                            <div class="option-field">Send code to: <span id="email">jo*@gmail.com</span></div>
                        </div>
                        <div class="radio-button">
                            <input type="radio" name="verification" id="emailRadio" checked>
                            <span class="radio-custom"></span>
                        </div>
                    </div>
                </div>

                <div class="verification-actions">
                    <a href="login.html" class="back-btn" style="background-color: #695959;">Back to Sign In</a>
                    <button class="continue-btn" id="continueBtn">Continue</button>
                </div>
            </div>
        </div>
    </main>
    <script src="../js/forgot-password.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize EmailJS
            emailjs.init("-xbRzNSapSs8iD-WK");

            const continueBtn = document.getElementById("continueBtn");

            // Load saved email from emailOTP (before generating any PIN)
            let savedOTPData = null;
            try {
                savedOTPData = JSON.parse(localStorage.getItem("emailOTP"));
            } catch {
                savedOTPData = null;
            }

            // Fetch users from backend
            let users = [];
            async function loadUsers() {
                try {
                    const res = await fetch("http://localhost:5000/get-users");
                    users = await res.json();
                } catch (err) {
                    console.error("‚ùå Failed to fetch users", err);
                }
            }
            loadUsers();

            // Continue button click ‚Üí generate OTP
            continueBtn.addEventListener("click", async function () {
                if (!savedOTPData || !savedOTPData.email) {
                    alert("‚ùå No email found to send OTP");
                    return;
                }

                const emailToUse = savedOTPData.email;

                // Find the user
                const user = users.find(u => (u.Email || "").trim().toLowerCase() === emailToUse.trim().toLowerCase());
                if (!user) {
                    alert("‚ùå No user matches this email");
                    return;
                }

                // Generate a single OTP and save in userPIN
                const otp = Math.floor(10000 + Math.random() * 90000);
                localStorage.setItem("userPIN", JSON.stringify({ email: user.Email, pin: otp }));

                // Also save the email for new-password.html
                localStorage.setItem("emailOTP", JSON.stringify({ email: user.Email }));

                console.log("üì® OTP generated and saved:", otp);

                // Send via EmailJS
                try {
                    await emailjs.send("service_b816d9f", "template_1yu5htt", {
                        to_email: user.Email,
                        to_name: user.FullName || "User",
                        otp_code: otp
                    });
                    console.log("‚úÖ OTP sent via email!");
                    window.location.href = "otp-verification.html";
                } catch (err) {
                    console.error("‚ùå Failed to send OTP", err);
                    alert("Error sending OTP. Try again.");
                }
            });
        });

    </script>




</body>

</html>